# https://taskfile.dev

version: '3'

vars:
  GIT_ROOT: { sh: git rev-parse --show-toplevel }
  GIT_ORIGIN: { sh: git ls-remote --get-url origin }
  KUBECONFIG: '{{.KUBECONFIG | default ""}}'

tasks:
  default:
    # silent: true
    aliases: [make]
    desc: "Corefile generator task."
    cmds:
      - |
        RND="{{.USER_WORKING_DIR}}/$(cat /dev/urandom | tr -dc 'a-z0-9' | fold -w 6 | head -n 1).core.bootstrap"
        echo SOURCE_REPO={{.GIT_ORIGIN}} > $RND
        echo SOURCE_KUBECONFIG=$(cat {{.KUBECONFIG}} | base64 -w0) >> $RND
    preconditions:
      - sh: test -f {{.KUBECONFIG}}
        msg: Specified KUBECONFIG file does NOT exists.
    requires:
      vars: [KUBECONFIG, GIT_ROOT, GIT_ORIGIN]